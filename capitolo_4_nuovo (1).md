Capitolo 4: Chiusura del Ciclo - Generazione e Verifica Ordini

Con un ecosistema di forecasting operativo che genera previsioni, queste devono essere trasformate in ordini concreti da inviare ai mercati elettrici. Questo capitolo descrive come è stata automatizzata l'intera catena dalla previsione all'ordine verificato, creando un sistema che riduce drasticamente i tempi operativi e il rischio di errori critici.

4.1. Il Rischio degli Ordini Errati sul Mercato

Nel mercato elettrico italiano, gli ordini vengono inviati al Gestore dei Mercati Energetici attraverso due mercati principali: il Mercato del Giorno Prima e la Piattaforma Conti Energia. Su questi mercati, ogni errore ha conseguenze economiche dirette e immediate.
Il Mercato del Giorno Prima è il principale mercato all'ingrosso dell'energia elettrica, dove gli operatori presentano le loro offerte di acquisto e vendita per ogni ora del giorno successivo. Le offerte devono essere inviate entro le 11 del mattino del giorno precedente la consegna. Il sistema del GME incrocia domanda e offerta e determina i prezzi orari per ciascuna delle sette zone di mercato.
Se un ordine non viene inviato correttamente, le conseguenze sono gravi. Un ordine mancante significa non aver acquistato energia per una determinata fascia oraria in una determinata zona, generando uno sbilanciamento completo per quella posizione,in questo modo per tutti i consumi effettivi dei nostri clienti per quella zona pagheremo l'energia al prezzo di sbilancio, Un ordine con quantità errate genera sbilanciamenti parziali. Un ordine con formato errato potrebbe essere rigettato dal sistema del GME senza che l'operatore se ne accorga immediatamente. Andare a sbilancio completamente su una zona puà essere molto pericoloso, se il mercato quel giorno è 'corto' e quindi, è stata prodotta meno energia di quella che viene effettivamente richesta dai vari operatori del settore per i propri clienti, il valore a sbilancio tenderà a salire e, rischieremo quindi di acquistare energia ad un costo addirittura superiore di quella a cui la possiamo rivendere ai nostri clienti. Per questo motivo è assolutamente importante che gli ordini di mercato vengano sempre caricati correttamente.

4.2. Generazione Ordini e File di Controllo

Il processo di generazione ordini si basa ancora su file Excel che contengono il forecast finale, risultato della combinazione tra forecast base tradizionale e correzioni manuali dell'operatore. Questo file Excel è stato potenziato per generare automaticamente, oltre ai file XML degli ordini da inviare al GME, anche file CSV di controllo.
I file CSV di controllo contengono, per ogni zona di mercato e per ogni ora dei giorni interessati, la quota in MWh che è stata allocata. Questa informazione viene estratta automaticamente dal forecast finale e salvata in un formato strutturato che facilita il successivo confronto automatizzato. Ogni file CSV è etichettato con la data di generazione e il tipo di mercato, permettendo di identificare univocamente quale set di ordini rappresenta.
Per generare i file XML veri e propri da inviare al GME, le macro Excel leggono le allocazioni dal foglio di forecast, applicano le regole di formattazione specifiche di ciascun mercato, gestiscono gli arrotondamenti secondo le convenzioni richieste, e producono file XML che seguono il tracciato ufficiale del GME con campi obbligatori, formati specifici per date e numeri, e struttura gerarchica predefinita.
Questo sistema di generazione è completamente tracciato. Ogni file generato viene salvato con timestamp, e viene registrato nel database quale versione delle previsioni è stata utilizzata, se ci sono state correzioni manuali e chi le ha effettuate. Questa tracciabilità è fondamentale per l'audit e per l'analisi retrospettiva delle performance.
L'architettura è stata progettata per essere flessibile fin dall'inizio. Attualmente il forecast finale proviene dal processo tradizionale con correzioni manuali. Ma sarà sufficiente modificare la sorgente dati per passare alle previsioni dei modelli ML una volta completata la loro validazione, senza dover riscrivere la logica di generazione degli ordini. Questa scelta progettuale garantisce che la futura transizione sarà rapida e a basso rischio.

4.3. Sistema di Verifica Automatica MGP e PCE

Una volta che i file XML sono stati caricati sulla piattaforma del GME, il rischio di errori non è terminato. Il sistema automatico di verifica confronta ciò che è stato inviato con ciò che il GME ha effettivamente ricevuto e registrato.
Il vecchio sistema di verifica era una macro VBA in Excel che richiedeva una serie di copia-incolla manuali tra file diversi. Quando il numero di righe da verificare superava il centinaio, i tempi di elaborazione diventavano proibitivi, arrivando a 10-15 minuti. Questa lentezza diventava particolarmente critica proprio nei giorni in cui si elaborano ordini multi-giorno, dove il volume di dati quadruplica o quintuplica.
Il nuovo sistema è stato completamente riscritto in Python, sfruttando le capacità di elaborazione vettorizzata di pandas. È stato compilato come applicazione eseguibile standalone con PyInstaller, permettendo distribuzione e utilizzo senza richiedere installazione di Python sulla macchina dell'operatore.
Il funzionamento del sistema si articola in diverse fasi coordinate. Primo, l'operatore scarica manualmente i file di riscontro dal portale GME: i file "Bid Offers" per il Mercato del Giorno Prima e i file "List Offers" per la Piattaforma Conti Energia. Questi file vengono salvati nella cartella Download standard del computer. Secondo, l'operatore lancia l'applicazione di verifica con un doppio click e inserisce la data di interesse quando richiesto. Terzo, il sistema recupera automaticamente i file di riscontro dalla cartella Download e i file CSV di controllo generati dal sistema di generazione ordini.
Il sistema gestisce le differenze di formato tra i due mercati con logiche specifiche. Per il Mercato del Giorno Prima, legge il file Bid Offers saltando le righe di intestazione, estrae le colonne rilevanti: zona, data, ora, stato, scopo, quantità. Filtra per Stato uguale a 'Valido' e Scopo uguale a 'Acquisto', perché solo questi ordini sono effettivamente attivi. Normalizza la data e converte la quantità in numerico. Per la Piattaforma Conti Energia, legge il file List Offers con le sue specificità di formato, estrae zona, data, ora, stato, quantità. Filtra per stati 'Sottomessa a PCE' e 'Congrua su PCE', che sono gli stati validi per questo mercato. La quantità in PCE è negativa per convenzione, quindi la converte in valore assoluto per il confronto.
Una volta normalizzati i dati GME e caricati i file di controllo, il sistema esegue un merge outer usando come chiavi data, ora e zona. Questo tipo di merge è cruciale perché permette di rilevare sia ordini presenti nel controllo ma mancanti nel GME, sia ordini presenti nel GME ma non nel controllo, situazione che potrebbe indicare ordini duplicati o errori di altra natura.
Per ogni combinazione di data-ora-zona, il sistema confronta la quantità inviata con la quantità ricevuta utilizzando la funzione np.isclose invece di un confronto di uguaglianza esatta. Questo gestisce le imprecisioni di rappresentazione in virgola mobile che potrebbero far apparire come diverse quantità che in realtà sono identiche a meno di errori di arrotondamento trascurabili.
Se vengono rilevate discrepanze, il sistema genera un report dettagliato che mostra solo le differenze, evitando di sovraccaricare l'operatore con informazioni ridondanti. Per ogni discrepanza vengono indicati data, ora, zona, quantità inviata e quantità ricevuta. L'operatore può quindi intervenire prontamente per correggere: rigenerare l'XML corretto, accedere al portale GME per stornare l'ordine errato, inviare il nuovo ordine e eseguire nuovamente la verifica.
Le performance del nuovo sistema sono drammaticamente superiori. Anche quando si allocano ordini per un'intera settimana con il formato quartorario, l'elaborazione richiede solo pochi secondi. Il sistema è stato testato con dataset simulati di consumo quartorario, quadruplicando il volume di dati, e le prestazioni si sono mantenute ottimali. Un processo che prima richiedeva 20-30 minuti di controllo manuale riga per riga ora viene completato in 5 secondi con certezza assoluta.
Il sistema non si stanca, non perde la concentrazione, non salta righe. Rileva qualsiasi discrepanza per quanto piccola e la evidenzia chiaramente. Questa affidabilità è fondamentale in un contesto dove un errore non rilevato può costare decine di migliaia di euro in penali di mercato.

4.4. Dalla Previsione all'Azione: Il Processo Completo End-to-End

Integrando tutti i componenti descritti in questo capitolo e nei precedenti, emerge il quadro completo del flusso operativo giornaliero che va dall'acquisizione dati fino agli ordini verificati sul mercato.
Il ciclo inizia con l'aggiornamento automatico dei dati. Il modulo data sourcing esegue le sue routine schedulate per acquisire consuntivi recenti, aggiornare dati meteo, sincronizzare forecast base. Ogni notte o al mattino presto, i dati vengono automaticamente aggiornati nel database senza intervento umano.
Parallelamente, i modelli di Machine Learning vengono eseguiti automaticamente generando Forecast V1 e Forecast V2 per i giorni successivi. Queste previsioni vengono salvate nel database con timestamp e rese immediatamente disponibili per la visualizzazione nelle dashboard.
L'operatore arriva al lavoro e apre il file Excel di forecasting insieme alla dashboard collegata a sql. Il forecast base è già stato generato automaticamente durante la notte dalle macro VBA, i dati meteo sono già stati rielaborati, e i modelli di ml hanno già elaborato le loro previsioni. L'operatore analizza i grafici considerando le sue conoscenze di mercato, condizioni speciali previste, comunicazioni ricevute da grandi clienti industriali. Applica le correzioni manuali che ritiene opportune.
Prima di finalizzare le allocazioni, l'operatore fa riferimento alla dashboard di visualizzazione per confrontare le sue decisioni con i suggerimenti dei modelli ML e con la curva suggerita. Vede graficamente se le sue allocazioni sono coerenti con i pattern storici e con le condizioni meteo previste. Se nota discrepanze significative senza una ragione valida, torna su Excel per affinare le allocazioni.
man mano che vengono applicate delle variazioni, l'operatore preme il pulsante "Trasferisci in SQL" nel file Excel per visualizzare direttamente le variaizoni sui grafici. Le allocazioni manuali vengono caricate nel database e diventano immediatamente visibili nella dashboard per un'ultima verifica visuale. Poi utilizza le macro Excel per generare i file XML degli ordini e i CSV di controllo. I file XML vengono caricati manualmente sul portale GME attraverso l'interfaccia web, l'applicazione di gestione dati sarebbe già in grado in maniera autonoma di generare i file xml per gli ordini di mercato e ha già tutte le funzioni necessarie alla verifica degli ordini ma come già detto in precedenza, al momento il modello di machine learning è solo in fase di testing.
Dopo alcuni minuti dal caricamento degli XML, il GME processa gli ordini e rende disponibili i file di riscontro Bid Offers e List Offers. L'operatore li scarica nella cartella Download, lancia l'applicazione di verifica con un doppio click, inserisce la data di interesse, e in pochi secondi ottiene il risultato. Se non ci sono discrepanze, il processo è completo. Se ci sono discrepanze, ha tutto il tempo necessario per rigenerare gli ordini corretti, stornarli e reinviarli prima della chiusura del mercato.
Questo flusso end-to-end è stato progettato per massimizzare l'automazione dove possibile, mantenere il controllo umano dove necessario, e minimizzare il rischio di errori in ogni fase. La combinazione di sistemi automatizzati, strumenti di supporto decisionale, e processi di verifica rigorosi crea un ecosistema robusto e affidabile.
L'infrastruttura completa è già operativa e collaudata. Anche se le previsioni dei modelli ML sono ancora in fase di validazione e non vengono utilizzate direttamente per gli ordini, l'intero sistema per trasformare qualsiasi previsione in ordini verificati funziona quotidianamente. Questo significa che la futura transizione dal metodo tradizionale al Machine Learning non richiederà la costruzione di nuova infrastruttura, ma semplicemente il cambio della sorgente dati delle previsioni.

Conclusioni del Capitolo

Questo capitolo ha descritto come il ciclo operativo si chiude con i sistemi di generazione e verifica automatica degli ordini. La riduzione dei tempi di verifica da 20-30 minuti a pochi secondi, l'eliminazione degli errori umani nel confronto, e la piena tracciabilità di tutte le operazioni rappresentano un salto di qualità significativo rispetto ai processi manuali precedenti.
L'integrazione fluida tra Excel tradizionale, database SQL, modelli ML, dashboard interattive e sistemi di verifica automatizzati dimostra come sia possibile modernizzare progressivamente un'infrastruttura operativa senza stravolgere i processi consolidati, ma affiancandoli con strumenti che li potenziano e li rendono più sicuri.
Nel prossimo e ultimo capitolo analizzeremo i risultati complessivi del progetto, l'impatto strategico sull'organizzazione, e il livello di innovazione introdotto rispetto alle pratiche standard del settore energetico.

